<style>
    .pure-control-group label {
        font-weight: bold;
    }

    .spinner {
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-left-color: #fff;
        border-radius: 50%;
        width: 12px;
        height: 12px;
        display: inline-block;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }
</style>

<h2>Current Firmware<span id="l1">
        <h6 style="display:inline"><b> Loading...</b></h6>
    </span></h2>
<div class="pure-form pure-form-aligned">
    <div class="pure-control-group">
        <label for="installed_version">Version</label>
        <span id='installed_version'></span>
    </div>
</div>

<h2>Online Update<span id="l2">
        <h6 style="display:inline"><b> Loading...</b></h6>
    </span></h2>
<div class="pure-form pure-form-aligned">
    <div class="pure-control-group">
        <label for="latest_version">Latest Version</label>
        <span id='latest_version'></span>
    </div>
    <div class="pure-control-group">
        <label for="title">Title</label>
        <span id='title' style="display: inline-block;"></span>
    </div>
    <div class="pure-control-group">
        <label for="release_date">Release Date</label>
        <span id='release_date'></span>
    </div>
    <div class="pure-control-group">
        <label for="release_summary">Summary</label>
        <span id='release_summary' style="display: inline-block;"></span>
    </div>

    <div class="pure-control-group">
        <label for="release_url">URL</label>
        <span id='release_url'></span>
    </div>
    <div class="pure-controls">
        <button class="pure-button pure-button-primary" id="refreshButton" style="background: #1cb841;">Refresh</button>
        <button class="pure-button pure-button-primary pure-button-disabled" id="updateButton"
            style="background: #df7514;">Update</button>
    </div>
</div>

<h2>Manual Update</h2>
<form class="pure-form pure-form-aligned" id="f" method='POST' action='/fw' enctype='multipart/form-data'>
    <fieldset>
        <div class="pure-control-group">
            <label for="name">Firmware File</label>
            <input type='file' name='fi' id='fi' accept='.bin' required>
        </div>
        <div class="pure-controls">
            <input type='submit' name='sub' id='sub' value='Upload Firmware' class="pure-button pure-button-primary">
        </div>

    </fieldset>
</form>
<span id='r'></span>

<script>
    //QuerySelector Prefix is added by load function to know into what element queySelector need to look for
    //var qsp = '#content0 ';

    function firmwareValidation() {
        const fileInput = $(qsp + '#fi');
        const productName = sessionStorage.getItem("ProductName");
        if (!fileInput || !productName) {
            return false;
        }

        let fn = fileInput.value;
        fn = fn.split(/(\\|\/)/g).pop();

        // Define the patterns for the filename
        const versionPattern = '\\d+\\.\\d+\\.\\d+';
        const filenamePattern1 = new RegExp(`^${productName}\\.${versionPattern}\\.bin$`, 'i');
        let filenamePattern2 = null;

        // If product name starts with 'W', define an additional pattern
        if (productName.startsWith('W')) {
            const productNameWithoutFirstChar = productName.substring(1);
            filenamePattern2 = new RegExp(`^Wireless${productNameWithoutFirstChar}\\.${versionPattern}\\.bin$`, 'i');
        }

        // Check if the filename matches either pattern
        if (!filenamePattern1.test(fn) && (!filenamePattern2 || !filenamePattern2.test(fn))) {
            alert(`You didn't select a valid Firmware file for ${productName}`);
            return false;
        }
        return confirm("Please do not power off the device during the update process.");
    }

    function getUpdateInfos(refresh = false) {

        const refreshButton = $(qsp + "#refreshButton");
        const originalButtonText = refreshButton.innerHTML;

        // Show loading animation
        refreshButton.innerHTML = '<span class="spinner"></span> Refreshing...';
        refreshButton.disabled = true;

        // add param to /gui for force refresh
        let url = "/gui";
        if (refresh) {
            url += "?refresh=true";
        }
        getJSON(url, function (GUI) {
            for (k in GUI) {
                if ((e = $(qsp + '#' + k)) != undefined) e.innerHTML = GUI[k];
            }
            // Restore button text and state
            refreshButton.innerHTML = originalButtonText;
            refreshButton.disabled = false;

            // Update the release URL
            const releaseUrlSpan = $('#release_url');
            const url = releaseUrlSpan.innerHTML;
            if (url) {
                releaseUrlSpan.innerHTML = `<a href="${url}" target="_blank">${url}</a>`;
            }

            // Update the Summary
            const releaseSummarySpan = $('#release_summary');
            const summary = releaseSummarySpan.innerHTML;
            if (summary) {
                releaseSummarySpan.innerHTML = summary.replace(/\r\n/g, '<br>').replace(/\n/g, '<br>');
            }

            fadeOut($(qsp + "#l1"));
            fadeOut($(qsp + "#l2"));

        }, function () {
            // Restore button text and state
            refreshButton.innerHTML = originalButtonText;
            refreshButton.disabled = false;
            $(qsp + "#l1").innerHTML = '<h4 style="display:inline;color:red;"><b> Failed</b></h4>';
            $(qsp + "#l2").innerHTML = '<h4 style="display:inline;color:red;"><b> Failed</b></h4>';
        });
    }
    getUpdateInfos();

    $(qsp + "#refreshButton").addEventListener('click', () => { getUpdateInfos(true); });


    $(qsp + "#f").addEventListener('submit', function (evt) {
        evt.preventDefault();
        if (!firmwareValidation()) return;
        $(qsp + '#r').innerHTML = 'In Progress';
        $(qsp + '#fi').readOnly = true;
        $(qsp + '#sub').disabled = true;
        post('/fw',
            new FormData($(qsp + '#f')),
            function () {
                var reload15sec = document.createElement('script');
                $(qsp + '#r').innerHTML = '<h3><span style="color: green;"><b>Done</b></span> System is rebooting. This page will be reloaded in <span id="cd">20</span>sec.</h3>';
                loadScript('startCountdown("#cd", 19, () => {location.reload();});');
                $(qsp + '#f').reset();
            },
            function (responseText) {
                $(qsp + '#r').innerHTML = '<span style="color: red;"><b>Failed</b></span> (' + responseText + ')';
                $(qsp + '#f').reset();
                $(qsp + '#fi').readOnly = false;
                $(qsp + '#sub').disabled = false;
            },
            30000,
            function (evt) {
                $(qsp + '#r').innerHTML = 'In Progress';
                if (evt.lengthComputable) $(qsp + '#r').innerHTML += ' : ' + evt.loaded / evt.total * 100 + '%';
            }
        );
    });
</script>